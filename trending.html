<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT äº¤æ˜“å¹³å° - ç†±é–€äº¤æ˜“</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        #walletAddressShort { cursor:pointer; transition:background 0.15s; border-radius:5px; padding:2px 8px;}
        #walletAddressShort:hover { background:#ece5ff; text-decoration:underline;}
        #walletModal {
            display: none; position: fixed; top: 90px; right: 40px; background: #fff;
            border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            z-index: 9999; padding: 28px 32px; min-width: 340px;
        }
    </style>
</head>
<body>
<header>
    <div class="container header-container">
        <a href="index.html" class="logo">
            <div class="logo-icon"><i class="fa-solid fa-wallet"></i></div>
            NFT Exchange
        </a>
        <div class="nav-wrapper">
            <nav class="main-nav">
                <a href="index.html" class="nav-link">é¦–é </a>
                <a href="trending.html" class="nav-link active">ç†±é–€äº¤æ˜“</a>
                <a href="my-cards.html" class="nav-link">æˆ‘çš„å¡ç‰‡</a>
                <a href="my-fav.html" class="nav-link">æˆ‘çš„æ”¶è—</a>
                <a href="history.html" class="nav-link">äº¤æ˜“æ­·å²</a>
                <a href="profile.html" class="nav-link">å€‹äººä¸­å¿ƒ</a>
            </nav>
        </div>
        <button id="connectWalletBtn" class="btn btn-primary">
            <i class="fa-solid fa-wallet" style="margin-right: 8px;"></i>é€£æ¥éŒ¢åŒ…
        </button>
        <div id="connectedWallet" style="display: none; color: var(--primary); font-weight: 500; font-size: 14px; align-items: center;">
            <i class="fa-solid fa-circle-check" style="margin-right: 5px; color: var(--success);"></i>
            <span id="walletAddressShort"><span id="walletAddress">0x1234...5678</span></span>
        </div>
    </div>
</header>
<div class="main-content">
    <div class="container">
        <h1 style="font-size: 28px; color: var(--dark); margin: 24px 0 24px 0;">ğŸ”¥ ç†±é–€äº¤æ˜“å°å¡</h1>
        <!-- NFT å¡ç‰‡å€ -->
        <div class="card-grid" id="cardGrid"></div>
    </div>
</div>
<!-- Toast è¨Šæ¯ -->
<div id="successToast" class="toast toast-success" style="display:none;">
    <div class="toast-icon"><i class="fa-solid fa-check"></i></div>
    <div class="toast-content">
        <div class="toast-title">æ“ä½œæˆåŠŸ</div>
        <div class="toast-message">æ“ä½œå·²æˆåŠŸå®Œæˆï¼</div>
    </div>
    <button class="toast-close"><i class="fa-solid fa-xmark"></i></button>
</div>
<div id="errorToast" class="toast toast-error" style="display:none;">
    <div class="toast-icon"><i class="fa-solid fa-xmark"></i></div>
    <div class="toast-content">
        <div class="toast-title">æ“ä½œå¤±æ•—</div>
        <div class="toast-message">ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚</div>
    </div>
    <button class="toast-close"><i class="fa-solid fa-xmark"></i></button>
</div>
<!-- éŒ¢åŒ…è³‡è¨Š Modal -->
<div id="walletModal">
    <div style="font-size:16px; font-weight:bold; margin-bottom:12px;">æˆ‘çš„éŒ¢åŒ…è³‡è¨Š</div>
    <div><span>åœ°å€ï¼š</span><span id="modalAddress" style="font-family:monospace"></span></div>
    <div style="margin:10px 0;">
        <span>ETH é¤˜é¡ï¼š</span><span id="modalBalance">è¼‰å…¥ä¸­...</span>
    </div>
    <div style="margin-bottom:14px;">
        <span>æœ€è¿‘äº¤æ˜“ï¼ˆå‰5ç­†ï¼‰ï¼š</span>
        <ul id="modalTxList" style="font-size:13px; padding-left:20px; margin-top: 4px;"></ul>
    </div>
    <div style="margin-bottom: 10px;">
        <input type="text" id="sendTo" placeholder="æ”¶æ¬¾åœ°å€" style="width:170px; font-size:13px; margin-bottom: 4px;">
        <input type="number" id="sendAmount" placeholder="ETH" style="width:70px; font-size:13px;">
        <button id="sendBtn" style="font-size:13px;">è½‰å¸³</button>
    </div>
    <button id="closeWalletModal" style="position:absolute;top:10px;right:18px; background:none; border:none; font-size:22px; color:#888; cursor:pointer;">Ã—</button>
</div>
<footer>
    <div class="container">
        <div class="footer-bottom">
            &copy; 2025 NFT Exchange. ä¿ç•™æ‰€æœ‰æ¬Šåˆ©ã€‚
        </div>
    </div>
</footer>
<script>
    // æ”¶è—è³‡æ–™å„²å­˜ï¼ˆlocalStorageï¼‰
    function saveCollections(arr) {
        localStorage.setItem('myCollections', JSON.stringify(arr));
    }
    function getCollections() {
        return JSON.parse(localStorage.getItem('myCollections') || '[]');
    }

    // ç†±é–€å‡è³‡æ–™ï¼ˆå¯æ¥APIï¼‰
    const trendingCards = [
        {
            id: 10,
            name: 'å¶åƒé–ƒå¡ #210',
            img: 'https://images.unsplash.com/photo-1482062364825-616fd23b8fc1?w=500&q=80',
            owner: 'FanMaster',
            price: '1.12 ETH',
            cardNo: '210'
        },
        {
            id: 11,
            name: 'é™å®šå¤¢å¹» #666',
            img: 'https://images.unsplash.com/photo-1500534314209-a25ddb2bd429?w=500&q=80',
            owner: 'RareCarder',
            price: '2.04 ETH',
            cardNo: '666'
        },
        {
            id: 12,
            name: 'ç²‰çµ²å† è» #888',
            img: 'https://images.unsplash.com/photo-1467934466021-f2425a1028b6?w=500&q=80',
            owner: 'StarChaser',
            price: '0.98 ETH',
            cardNo: '888'
        }
    ];

    function renderCards() {
        let myCollections = getCollections();
        const grid = document.getElementById('cardGrid');
        grid.innerHTML = '';
        trendingCards.forEach(card => {
            const isFav = myCollections.find(c => c.id === card.id);
            const el = document.createElement('div');
            el.className = "nft-card";
            el.innerHTML = `
                <div class="card-image">
                    <img src="${card.img}" alt="NFT Card Image">
                </div>
                <div class="card-content">
                    <h3>${card.name}</h3>
                    <div class="card-meta">å¡è™Ÿï¼š${card.cardNo}ã€€ï½œã€€æ“æœ‰è€…ï¼š${card.owner}</div>
                    <div class="card-meta">åƒ¹æ ¼ï¼š<span style="color:#7e57c2;font-weight:bold;">${card.price}</span></div>
                    <div class="card-actions">
                        <button class="btn btn-primary btn-detail" data-id="${card.id}"><i class="fa-solid fa-circle-info"></i> è©³æƒ…</button>
                        ${
                            isFav
                            ? `<button class="btn btn-fav btn-remove-fav" data-id="${card.id}"><i class="fa-solid fa-heart-crack"></i> å–æ¶ˆæ”¶è—</button>`
                            : `<button class="btn btn-outline btn-add-fav" data-id="${card.id}"><i class="fa-regular fa-heart"></i> æ”¶è—</button>`
                        }
                    </div>
                </div>
            `;
            grid.appendChild(el);
        });
        // ç¶å®šæ”¶è—/å–æ¶ˆ
        document.querySelectorAll('.btn-add-fav').forEach(btn => {
            btn.onclick = function() {
                let myCollections = getCollections();
                const id = parseInt(this.dataset.id);
                const card = trendingCards.find(c => c.id === id);
                if (card && !myCollections.find(c => c.id === id)) {
                    myCollections.push(card);
                    saveCollections(myCollections);
                    renderCards();
                    showToast(successToast, 'å·²æ”¶è—', 'æˆåŠŸæ”¶è—è©²å¡ç‰‡ï¼');
                }
            }
        });
        document.querySelectorAll('.btn-remove-fav').forEach(btn => {
            btn.onclick = function() {
                let myCollections = getCollections();
                const id = parseInt(this.dataset.id);
                myCollections = myCollections.filter(c => c.id !== id);
                saveCollections(myCollections);
                renderCards();
                showToast(successToast, 'å·²å–æ¶ˆæ”¶è—', 'å·²å¾æ”¶è—æ¸…å–®ç§»é™¤è©²å¡ç‰‡ï¼');
            }
        });
        // è©³æƒ…è·³è½‰
        document.querySelectorAll('.btn-detail').forEach(btn => {
            btn.onclick = function() {
                window.location.href = `details.html?id=${this.dataset.id}`;
            }
        });
    }
    function showToast(toast, title, message) {
        toast.querySelector('.toast-title').textContent = title;
        toast.querySelector('.toast-message').textContent = message;
        toast.style.display = "flex";
        setTimeout(() => { toast.style.display = "none"; }, 2200);
    }
    document.addEventListener('DOMContentLoaded', function() {
        renderCards();

        // Toast é—œé–‰
        document.querySelectorAll('.toast-close').forEach(btn => {
            btn.addEventListener('click', function() {
                this.closest('.toast').style.display = "none";
            });
        });

        // ====== éŒ¢åŒ…å€å¡Š ======
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const connectedWallet = document.getElementById('connectedWallet');
        const walletAddress = document.getElementById('walletAddress');
        const walletAddressShort = document.getElementById('walletAddressShort');
        const successToast = document.getElementById('successToast');
        const errorToast = document.getElementById('errorToast');
        const walletModal = document.getElementById('walletModal');
        const modalAddress = document.getElementById('modalAddress');
        const modalBalance = document.getElementById('modalBalance');
        const modalTxList = document.getElementById('modalTxList');
        const sendBtn = document.getElementById('sendBtn');
        const sendTo = document.getElementById('sendTo');
        const sendAmount = document.getElementById('sendAmount');
        const closeWalletModal = document.getElementById('closeWalletModal');
        const etherscanApiKey = '6YW54UYMMFRE4ZYYWDJ6KRVKZU7ZBDK16C'; // æ¸¬è©¦ç”¨

        // è‡ªå‹•éŒ¢åŒ…é¡¯ç¤º
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.request({ method: 'eth_accounts' })
                .then(accounts => {
                    if (accounts.length > 0) {
                        const shortenedAddress = accounts[0].slice(0, 6) + '...' + accounts[0].slice(-4);
                        walletAddress.textContent = shortenedAddress;
                        connectWalletBtn.style.display = 'none';
                        connectedWallet.style.display = 'flex';
                    } else {
                        connectWalletBtn.style.display = 'block';
                        connectedWallet.style.display = 'none';
                    }
                });
        } else {
            connectWalletBtn.style.display = 'block';
            connectedWallet.style.display = 'none';
        }

        connectWalletBtn.addEventListener('click', async function() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    if (accounts.length > 0) {
                        const shortenedAddress = accounts[0].slice(0, 6) + '...' + accounts[0].slice(-4);
                        walletAddress.textContent = shortenedAddress;
                        connectWalletBtn.style.display = 'none';
                        connectedWallet.style.display = 'flex';
                        showToast(successToast, 'éŒ¢åŒ…å·²é€£æ¥', 'æ‚¨çš„éŒ¢åŒ…å·²æˆåŠŸé€£æ¥åˆ°å¹³å°ï¼');
                    }
                } catch (error) {
                    showToast(errorToast, 'é€£æ¥å¤±æ•—', 'ç„¡æ³•é€£æ¥åˆ°éŒ¢åŒ…ï¼Œè«‹ç¢ºä¿æ‚¨å·²å®‰è£ MetaMask ä¸¦å·²ç™»å…¥ã€‚');
                }
            } else {
                showToast(errorToast, 'æœªåµæ¸¬åˆ°éŒ¢åŒ…', 'è«‹å®‰è£ MetaMask æˆ–å…¶ä»–ä»¥å¤ªåŠéŒ¢åŒ…æ“´å……åŠŸèƒ½ã€‚');
            }
        });

        // éŒ¢åŒ…åºè™Ÿé¡¯ç¤ºmodal
        walletAddressShort.addEventListener('click', async function() {
            if (!window.ethereum || !window.ethereum.selectedAddress) {
                showToast(errorToast, 'è«‹å…ˆé€£æ¥éŒ¢åŒ…', 'è«‹å…ˆé€£æ¥éŒ¢åŒ…å†æŸ¥çœ‹è©³æƒ…');
                return;
            }
            const addr = window.ethereum.selectedAddress;
            modalAddress.textContent = addr;
            walletModal.style.display = "block";
            modalBalance.textContent = 'è¼‰å…¥ä¸­...';
            modalTxList.innerHTML = '<li>è¼‰å…¥ä¸­...</li>';
            // æŸ¥é¤˜é¡
            try {
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const balance = await provider.getBalance(addr);
                modalBalance.textContent = ethers.utils.formatEther(balance) + " ETH";
            } catch (e) {
                modalBalance.textContent = 'å–å¾—å¤±æ•—';
            }
            // æŸ¥æœ€è¿‘äº¤æ˜“ï¼ˆå‰5ç­†ï¼‰
            try {
                const apiUrl = `https://api.etherscan.io/api?module=account&action=txlist&address=${addr}&sort=desc&apikey=${etherscanApiKey}`;
                const res = await fetch(apiUrl);
                const data = await res.json();
                modalTxList.innerHTML = '';
                if (data.result && data.result.length > 0) {
                    data.result.slice(0,5).forEach(tx=>{
                        const li = document.createElement('li');
                        li.innerHTML = `TxHash: <a href="https://etherscan.io/tx/${tx.hash}" target="_blank">${tx.hash.slice(0,10)}...</a> <br> Value: ${ethers.utils.formatEther(tx.value)} ETH`;
                        modalTxList.appendChild(li);
                    });
                } else {
                    modalTxList.innerHTML = '<li>æš«ç„¡ç´€éŒ„</li>';
                }
            } catch (e) {
                modalTxList.innerHTML = '<li>è¼‰å…¥å¤±æ•—</li>';
            }
        });
        closeWalletModal.addEventListener('click', function(){
            walletModal.style.display = 'none';
        });

        sendBtn.addEventListener('click', async function() {
            if (!window.ethereum || !window.ethereum.selectedAddress) {
                alert('è«‹å…ˆé€£æ¥éŒ¢åŒ…');
                return;
            }
            const to = sendTo.value;
            const value = sendAmount.value;
            if (!to || !value) {
                alert('è«‹è¼¸å…¥å°æ–¹åœ°å€å’Œé‡‘é¡');
                return;
            }
            try {
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const signer = provider.getSigner();
                const tx = await signer.sendTransaction({
                    to,
                    value: ethers.utils.parseEther(value)
                });
                alert('é€å‡ºæˆåŠŸï¼ŒTxHashï¼š' + tx.hash);
            } catch(e) {
                alert('è½‰å¸³å¤±æ•—ï¼š' + (e.data?.message || e.message));
            }
        });
    });
</script>
</body>
</html>
