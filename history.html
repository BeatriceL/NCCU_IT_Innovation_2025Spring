<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT äº¤æ˜“å¹³å° - äº¤æ˜“æ­·å²</title>
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        #walletAddressShort { cursor:pointer; transition:background 0.15s; border-radius:5px; padding:2px 8px;}
        #walletAddressShort:hover { background:#ece5ff; text-decoration:underline;}
        #walletModal {
            display: none; position: fixed; top: 90px; right: 40px; background: #fff;
            border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            z-index: 9999; padding: 28px 32px; min-width: 340px;
        }
    </style>
</head>
<body>
<header>
    <div class="container header-container">
        <a href="index.html" class="logo">
            <div class="logo-icon"><i class="fa-solid fa-wallet"></i></div>
            NFT Exchange
        </a>
        <div class="nav-wrapper">
            <nav class="main-nav">
                <a href="index.html" class="nav-link">é¦–é </a>
                <a href="trending.html" class="nav-link">ç†±é–€äº¤æ˜“</a>
                <a href="my-cards.html" class="nav-link">æˆ‘çš„å¡ç‰‡</a>
                <a href="my-fav.html" class="nav-link">æˆ‘çš„æ”¶è—</a>
                <a href="history.html" class="nav-link active">äº¤æ˜“æ­·å²</a>
                <a href="profile.html" class="nav-link">å€‹äººä¸­å¿ƒ</a>
            </nav>
        </div>
        <button id="connectWalletBtn" class="btn btn-primary">
            <i class="fa-solid fa-wallet" style="margin-right: 8px;"></i>é€£æ¥éŒ¢åŒ…
        </button>
        <div id="connectedWallet" style="display: none; color: var(--primary); font-weight: 500; font-size: 14px; align-items: center;">
            <i class="fa-solid fa-circle-check" style="margin-right: 5px; color: var(--success);"></i>
            <span id="walletAddressShort"><span id="walletAddress">0x1234...5678</span></span>
        </div>
    </div>
</header>
<div class="main-content">
    <div class="container">
        <h1 style="font-size: 28px; color: var(--dark); margin: 24px 0 24px 0;">ğŸ“‘ äº¤æ˜“æ­·å²</h1>
        <table class="history-table" id="historyTable">
            <thead>
                <tr>
                    <th>äº¤æ˜“æ™‚é–“</th>
                    <th>é¡å‹</th>
                    <th>å¡ç‰‡åç¨±</th>
                    <th>äº¤æ˜“å°è±¡</th>
                    <th>é‡‘é¡</th>
                    <th>äº¤æ˜“å“ˆå¸Œ</th>
                </tr>
            </thead>
            <tbody>
                <!-- äº¤æ˜“ç´€éŒ„å‹•æ…‹ç”Ÿæˆ -->
            </tbody>
        </table>
        <div id="noHistoryMsg" style="display:none; color:#888; text-align:center; font-size:20px; margin-top:40px;">
            æš«ç„¡äº¤æ˜“ç´€éŒ„ï¼Œå¿«å»é«”é©— NFT å°å¡äº¤æ˜“å§ï¼
        </div>
    </div>
</div>
<!-- Toast è¨Šæ¯ -->
<div id="successToast" class="toast toast-success" style="display:none;">
    <div class="toast-icon"><i class="fa-solid fa-check"></i></div>
    <div class="toast-content">
        <div class="toast-title">æ“ä½œæˆåŠŸ</div>
        <div class="toast-message">æ“ä½œå·²æˆåŠŸå®Œæˆï¼</div>
    </div>
    <button class="toast-close"><i class="fa-solid fa-xmark"></i></button>
</div>
<div id="errorToast" class="toast toast-error" style="display:none;">
    <div class="toast-icon"><i class="fa-solid fa-xmark"></i></div>
    <div class="toast-content">
        <div class="toast-title">æ“ä½œå¤±æ•—</div>
        <div class="toast-message">ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚</div>
    </div>
    <button class="toast-close"><i class="fa-solid fa-xmark"></i></button>
</div>
<!-- éŒ¢åŒ…è³‡è¨Š Modal -->
<div id="walletModal">
    <div style="font-size:16px; font-weight:bold; margin-bottom:12px;">æˆ‘çš„éŒ¢åŒ…è³‡è¨Š</div>
    <div><span>åœ°å€ï¼š</span><span id="modalAddress" style="font-family:monospace"></span></div>
    <div style="margin:10px 0;">
        <span>ETH é¤˜é¡ï¼š</span><span id="modalBalance">è¼‰å…¥ä¸­...</span>
    </div>
    <div style="margin-bottom:14px;">
        <span>æœ€è¿‘äº¤æ˜“ï¼ˆå‰5ç­†ï¼‰ï¼š</span>
        <ul id="modalTxList" style="font-size:13px; padding-left:20px; margin-top: 4px;"></ul>
    </div>
    <div style="margin-bottom: 10px;">
        <input type="text" id="sendTo" placeholder="æ”¶æ¬¾åœ°å€" style="width:170px; font-size:13px; margin-bottom: 4px;">
        <input type="number" id="sendAmount" placeholder="ETH" style="width:70px; font-size:13px;">
        <button id="sendBtn" style="font-size:13px;">è½‰å¸³</button>
    </div>
    <button id="closeWalletModal" style="position:absolute;top:10px;right:18px; background:none; border:none; font-size:22px; color:#888; cursor:pointer;">Ã—</button>
</div>
<footer>
    <div class="container">
        <div class="footer-bottom">
            &copy; 2025 NFT Exchange. ä¿ç•™æ‰€æœ‰æ¬Šåˆ©ã€‚
        </div>
    </div>
</footer>
<script>
    // å‡è³‡æ–™ï¼šä½ å¯ä»¥ä¹‹å¾Œæ”¹å¾API/éŒ¢åŒ…äº¤æ˜“åŒæ­¥
    const fakeHistory = [
        {
            type: 'buy',
            cardName: 'æ¥µå…‰å¹»æƒ³ #001',
            target: '0xA34d...ab88',
            amount: '0.45 ETH',
            time: '2025-05-18 21:31',
            tx: '0xb95617c0bc...e1e1ca3a2'
        },
        {
            type: 'sell',
            cardName: 'è™›æ“¬å±±æ°´ #128',
            target: '0xF134...cd07',
            amount: '0.33 ETH',
            time: '2025-05-14 19:20',
            tx: '0xcfe12c713a...1d25d876'
        }
    ];

    function renderHistory() {
        const table = document.getElementById('historyTable').querySelector('tbody');
        table.innerHTML = '';
        if (fakeHistory.length === 0) {
            document.getElementById('noHistoryMsg').style.display = '';
        } else {
            document.getElementById('noHistoryMsg').style.display = 'none';
            fakeHistory.forEach(his => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${his.time}</td>
                    <td><span class="tag tag-${his.type}">${his.type === 'buy' ? 'è³¼è²·' : 'å‡ºå”®'}</span></td>
                    <td>${his.cardName}</td>
                    <td style="font-family:monospace;">${his.target}</td>
                    <td style="color:#7e57c2; font-weight:bold;">${his.amount}</td>
                    <td>
                        <a href="https://etherscan.io/tx/${his.tx}" target="_blank">${his.tx.slice(0,13)}...</a>
                    </td>
                `;
                table.appendChild(tr);
            });
        }
    }
    function showToast(toast, title, message) {
        toast.querySelector('.toast-title').textContent = title;
        toast.querySelector('.toast-message').textContent = message;
        toast.style.display = "flex";
        setTimeout(() => { toast.style.display = "none"; }, 2200);
    }
    document.addEventListener('DOMContentLoaded', function() {
        renderHistory();

        // Toast é—œé–‰
        document.querySelectorAll('.toast-close').forEach(btn => {
            btn.addEventListener('click', function() {
                this.closest('.toast').style.display = "none";
            });
        });

        // ====== éŒ¢åŒ…å€å¡Š ======
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const connectedWallet = document.getElementById('connectedWallet');
        const walletAddress = document.getElementById('walletAddress');
        const walletAddressShort = document.getElementById('walletAddressShort');
        const successToast = document.getElementById('successToast');
        const errorToast = document.getElementById('errorToast');
        const walletModal = document.getElementById('walletModal');
        const modalAddress = document.getElementById('modalAddress');
        const modalBalance = document.getElementById('modalBalance');
        const modalTxList = document.getElementById('modalTxList');
        const sendBtn = document.getElementById('sendBtn');
        const sendTo = document.getElementById('sendTo');
        const sendAmount = document.getElementById('sendAmount');
        const closeWalletModal = document.getElementById('closeWalletModal');
        const etherscanApiKey = '6YW54UYMMFRE4ZYYWDJ6KRVKZU7ZBDK16C';

        // è‡ªå‹•éŒ¢åŒ…é¡¯ç¤º
        if (typeof window.ethereum !== 'undefined') {
            window.ethereum.request({ method: 'eth_accounts' })
                .then(accounts => {
                    if (accounts.length > 0) {
                        const shortenedAddress = accounts[0].slice(0, 6) + '...' + accounts[0].slice(-4);
                        walletAddress.textContent = shortenedAddress;
                        connectWalletBtn.style.display = 'none';
                        connectedWallet.style.display = 'flex';
                    } else {
                        connectWalletBtn.style.display = 'block';
                        connectedWallet.style.display = 'none';
                    }
                });
        } else {
            connectWalletBtn.style.display = 'block';
            connectedWallet.style.display = 'none';
        }

        connectWalletBtn.addEventListener('click', async function() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    if (accounts.length > 0) {
                        const shortenedAddress = accounts[0].slice(0, 6) + '...' + accounts[0].slice(-4);
                        walletAddress.textContent = shortenedAddress;
                        connectWalletBtn.style.display = 'none';
                        connectedWallet.style.display = 'flex';
                        showToast(successToast, 'éŒ¢åŒ…å·²é€£æ¥', 'æ‚¨çš„éŒ¢åŒ…å·²æˆåŠŸé€£æ¥åˆ°å¹³å°ï¼');
                    }
                } catch (error) {
                    showToast(errorToast, 'é€£æ¥å¤±æ•—', 'ç„¡æ³•é€£æ¥åˆ°éŒ¢åŒ…ï¼Œè«‹ç¢ºä¿æ‚¨å·²å®‰è£ MetaMask ä¸¦å·²ç™»å…¥ã€‚');
                }
            } else {
                showToast(errorToast, 'æœªåµæ¸¬åˆ°éŒ¢åŒ…', 'è«‹å®‰è£ MetaMask æˆ–å…¶ä»–ä»¥å¤ªåŠéŒ¢åŒ…æ“´å……åŠŸèƒ½ã€‚');
            }
        });

        // éŒ¢åŒ…åºè™Ÿé¡¯ç¤ºmodal
        walletAddressShort.addEventListener('click', async function() {
            if (!window.ethereum || !window.ethereum.selectedAddress) {
                showToast(errorToast, 'è«‹å…ˆé€£æ¥éŒ¢åŒ…', 'è«‹å…ˆé€£æ¥éŒ¢åŒ…å†æŸ¥çœ‹è©³æƒ…');
                return;
            }
            const addr = window.ethereum.selectedAddress;
            modalAddress.textContent = addr;
            walletModal.style.display = "block";
            modalBalance.textContent = 'è¼‰å…¥ä¸­...';
            modalTxList.innerHTML = '<li>è¼‰å…¥ä¸­...</li>';
            // æŸ¥é¤˜é¡
            try {
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const balance = await provider.getBalance(addr);
                modalBalance.textContent = ethers.utils.formatEther(balance) + " ETH";
            } catch (e) {
                modalBalance.textContent = 'å–å¾—å¤±æ•—';
            }
            // æŸ¥æœ€è¿‘äº¤æ˜“ï¼ˆå‰5ç­†ï¼‰
            try {
                const apiUrl = `https://api.etherscan.io/api?module=account&action=txlist&address=${addr}&sort=desc&apikey=${etherscanApiKey}`;
                const res = await fetch(apiUrl);
                const data = await res.json();
                modalTxList.innerHTML = '';
                if (data.result && data.result.length > 0) {
                    data.result.slice(0,5).forEach(tx=>{
                        const li = document.createElement('li');
                        li.innerHTML = `TxHash: <a href="https://etherscan.io/tx/${tx.hash}" target="_blank">${tx.hash.slice(0,10)}...</a> <br> Value: ${ethers.utils.formatEther(tx.value)} ETH`;
                        modalTxList.appendChild(li);
                    });
                } else {
                    modalTxList.innerHTML = '<li>æš«ç„¡ç´€éŒ„</li>';
                }
            } catch (e) {
                modalTxList.innerHTML = '<li>è¼‰å…¥å¤±æ•—</li>';
            }
        });
        closeWalletModal.addEventListener('click', function(){
            walletModal.style.display = 'none';
        });

        sendBtn.addEventListener('click', async function() {
            if (!window.ethereum || !window.ethereum.selectedAddress) {
                alert('è«‹å…ˆé€£æ¥éŒ¢åŒ…');
                return;
            }
            const to = sendTo.value;
            const value = sendAmount.value;
            if (!to || !value) {
                alert('è«‹è¼¸å…¥å°æ–¹åœ°å€å’Œé‡‘é¡');
                return;
            }
            try {
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                const signer = provider.getSigner();
                const tx = await signer.sendTransaction({
                    to,
                    value: ethers.utils.parseEther(value)
                });
                alert('é€å‡ºæˆåŠŸï¼ŒTxHashï¼š' + tx.hash);
            } catch(e) {
                alert('è½‰å¸³å¤±æ•—ï¼š' + (e.data?.message || e.message));
            }
        });
    });
</script>
</body>
</html>
